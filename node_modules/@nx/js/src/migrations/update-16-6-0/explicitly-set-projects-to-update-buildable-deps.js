"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const devkit_1 = require("@nx/devkit");
const executors = new Set([
    '@nx/js:swc',
    '@nrwl/js:swc',
    '@nx/js:tsc',
    '@nrwl/js:tsc',
]);
function default_1(tree) {
    var _a;
    var _b;
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        // use project graph to get the expanded target configurations
        const projectGraph = yield (0, devkit_1.createProjectGraphAsync)();
        for (const [projectName, { data: projectData }] of Object.entries(projectGraph.nodes)) {
            if (projectData.projectType !== 'library') {
                continue;
            }
            for (const [targetName, target] of Object.entries(projectData.targets || {})) {
                if (!executors.has(target.executor)) {
                    continue;
                }
                if (!target.options ||
                    target.options.updateBuildableProjectDepsInPackageJson === undefined) {
                    // read the project configuration to write the explicit project configuration
                    // and avoid writing the expanded target configuration
                    const project = (0, devkit_1.readProjectConfiguration)(tree, projectName);
                    (_a = (_b = project.targets[targetName]).options) !== null && _a !== void 0 ? _a : (_b.options = {});
                    project.targets[targetName].options.updateBuildableProjectDepsInPackageJson = true;
                    (0, devkit_1.updateProjectConfiguration)(tree, projectName, project);
                }
            }
        }
        yield (0, devkit_1.formatFiles)(tree);
    });
}
exports.default = default_1;
